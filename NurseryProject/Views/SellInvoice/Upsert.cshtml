@model NurseryProject.Dtos.PurchaseInvoices.PurchaseInvoicePostVM
@{
    ViewBag.Title = "فاتورة مبيعات";
}

<form method="post">

    <!-- ================== البيانات الأساسية ================== -->
    <div class="card mb-3">
        <div class="card-header bg-light">
            <strong>البيانات الأساسية</strong>
        </div>
        <div class="card-body row">

            <div class="col-md-3">
                <label>رقم الفاتورة</label>
                @Html.TextBoxFor(x => x.InvoiceNumber, new { @class = "form-control" })
            </div>

            <div class="col-md-3">
                <label>التاريخ</label>
                @Html.TextBoxFor(x => x.InvoiceDate, "{0:yyyy-MM-dd}",
                    new { @type = "date", @class = "form-control" })
            </div>

            <div class="col-md-3">
                <label>الطالب</label>
                @Html.DropDownListFor(x => x.StudentId,
                    null, "اختر الطالب", new { @class = "form-control searchable" })
            </div>

            <div class="col-md-3">
                <label>المخزن</label>
                @Html.DropDownListFor(x => x.StoreId,
                    null, "اختر المخزن", new { @class = "form-control " })
            </div>
            <input type="hidden" id="StoreIdHidden" name="StoreId" />

        </div>
    </div>

    <!-- ================== الأصناف ================== -->
    <div class="card mb-3">
        <div class="card-header bg-light">
            <strong>الأصناف</strong>
        </div>

        <div class="card-body row align-items-end">

            <div class="col-md-4">
                <label>الصنف</label>

                @Html.DropDownList("itemId",
                null, "--اختر-- ", new { @class = "form-control searchable" })
            </div>
            <div class="col-md-4">
                <label>الكمية المتاحة</label>
                <input type="number" id="availablequantity" class="form-control text-center" readonly />
            </div>
            <div class="col-md-4">
                <label>الكمية</label>
                <input type="number" id="qty" class="form-control text-center" min="1" />
            </div>

            <div class="col-md-4">
                <label>السعر</label>
                <input type="number" id="price" class="form-control text-center" />
            </div>

            <div class="col-md-4">
                <label>الإجمالي</label>
                <input type="text" id="amount" class="form-control text-center" readonly />
            </div>

            <div class="col-md-3 ms-auto">
                <button type="button" class="btn btn-success w-100" onclick="addItem()">
                    إضافة
                </button>
            </div>

        </div>


        <!-- جدول الأصناف -->
        <div class="card-body">
            <table class="table table-bordered" id="itemsTable">
                <thead>
                    <tr>
                        <th>الصنف</th>
                        <th>الكمية</th>
                        <th>السعر</th>
                        <th>الإجمالي</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- ================== إجماليات ================== -->
    <div class="card">
        <div class="card-body row">

            <div class="col-md-3">
                <label>إجمالي الأصناف</label>
                <input type="text" id="totalItems" class="form-control" readonly />
            </div>

            <div class="col-md-3">
                <label>الخصم</label>
                @Html.TextBoxFor(x => x.Discount, new { @class = "form-control", oninput = "calcNet()" })
            </div>

            <div class="col-md-3">
                <label>الإجمالي بعد الخصم</label>
                <input type="text" id="netTotal" class="form-control" readonly />
            </div>

            <input type="hidden" id="ItemsJson" name="ItemsJson" />



        </div>
        <div class="row">
            <div class="col-md-3 ms-auto">
                <button type="button" class="btn btn-primary w-100" onclick="submitForm()">
                    حفظ الفاتورة
                </button>
            </div>
        </div>
    </div>

</form>

@section scripts {
    @if (ViewBag.ItemsJson != null)
    {
        <script>
            let StoreId = $('#StoreId').val();

            $('#StoreIdHidden').val(StoreId);

            $('#StoreId')
                .prop('disabled', true);


        </script>
    }

    <script>

// =======================
// المتغيرات الأساسية
// =======================
let items = [];
let total = 0;

// =======================
// تحميل بيانات التعديل
// =======================

@if (ViewBag.ItemsJson != null)
{

    <text>
        items = @Html.Raw(ViewBag.ItemsJson);
        total = items.reduce((s, x) => s + x.Amount, 0);
    </text>

}

// بناء الجدول عند التحميل
$(document).ready(function () {

    items.forEach(function (i) {
        addRow(i.ItemId, i.ItemName, i.Quantity, i.PurchasePrice, i.Amount);
    });

    updateTotals();
});

// =======================
// إضافة صف للجدول فقط
// =======================
function addRow(id, name, qty, price, amount) {

    $('#itemsTable tbody').append(`
        <tr data-item-id="${id}">
            <td>${name}</td>
            <td>${qty}</td>
            <td>${price}</td>
            <td>${amount.toFixed(2)}</td>
            <td>
                <button class="btn btn-danger btn-sm"
                    onclick="removeItem(this, '${id}', ${amount})">X</button>
            </td>
        </tr>
    `);
}

// =======================
// إضافة صنف
// =======================
function addItem() {

    let id = $('#itemId').val();
    let StoreId = $('#StoreId').val();

    let name = $('#itemId option:selected').text();
    let qty = parseFloat($('#qty').val());
    let price = parseFloat($('#price').val());
    let availablequantity = parseFloat($('#availablequantity').val());

    if (availablequantity <= 0 || availablequantity < qty) {
        invokeAlert('الكمية المتاحة لا تكفي', '', 'warning', 2000);

        return;
    }
    if (!StoreId) {
        invokeAlert('أختر المخزن', '', 'warning', 2000);

        return;
    }
    if (!id || qty <= 0 || price <= 0) {
        invokeAlert('أدخل بيانات صحيحة', '', 'warning', 2000);

        return;
    }

    if (items.some(x => x.ItemId === id)) {
        invokeAlert('الصنف مضاف بالفعل', '', 'warning', 2000);

        return;
    }

    let amount = qty * price;

    items.push({
        ItemId: id,
        ItemName: name,
        Quantity: qty,
        PurchasePrice: price,
        Amount: amount
    });

    addRow(id, name, qty, price, amount);

    total += amount;
    updateTotals();
    clearInputs();

    $('#StoreId')
        .prop('disabled', true);

    $('#StoreIdHidden').val(StoreId);



}

// =======================
// حذف صنف
// =======================
function removeItem(btn, id, amt) {

    items = items.filter(x => x.ItemId !== id);

    $(btn).closest('tr').remove();

    total -= amt;
    updateTotals();
}

// =======================
// إجماليات
// =======================
function updateTotals() {
    $('#totalItems').val(total.toFixed(2));
    calcNet();
}

function calcNet() {
    let discount = parseFloat($('#Discount').val() || 0);
    $('#netTotal').val((total - discount).toFixed(2));
}

// =======================
// فورم الحفظ
// =======================
function submitForm() {

    if (items.length === 0) {
        invokeAlert('أضف صنف واحد على الأقل', '', 'warning', 2000);

        return;
    }

    $('#ItemsJson').val(JSON.stringify(items));
    $("form").submit();
}

// =======================
// تفريغ
// =======================
function clearInputs() {
    $('#qty').val('');
    $('#price').val('');
    $('#amount').val('');
}

// =======================
// تغيير الصنف
// =======================
        $('#itemId').on('change', function () {

            let itemId = $(this).val();
            let StoreId = $('#StoreId').val();

            if (!itemId) {
                clearInputs();
                return;
            }

            $.ajax({
                url: '/SellInvoice/GetItemPrice',
                type: 'GET',
                data: { id: itemId, StoreId: StoreId},
                success: function (res) {
                    if (res) {
                        let p = res.SellPrice;

                        $('#availablequantity').val(res.quantity);
                        $('#price').val(p);
                        $('#qty').val(1);
                        $('#amount').val((1 * p).toFixed(2));
                    } else {
                        clearInputs();
                    }
                },
                error: function () {
                    invokeAlert('تأكد من اختيار المخزن اولا', '', 'warning', 2000);

                }
            });

        });

// تحديث الإجمالي
$('#qty, #price').on('input', function () {
    let q = parseFloat($('#qty').val() || 0);
    let p = parseFloat($('#price').val() || 0);
    $('#amount').val((q * p).toFixed(2));
});

    </script>
}
